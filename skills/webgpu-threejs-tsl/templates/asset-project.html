<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebGPU + Three.js + TSL with Asset Library</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #000;
      overflow: hidden;
    }

    canvas {
      display: block;
      width: 100%;
      height: 100vh;
    }

    #loading {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #fff;
      font-size: 18px;
      text-align: center;
    }

    #loading.hidden {
      display: none;
    }

    .spinner {
      border: 3px solid #333;
      border-top: 3px solid #0066ff;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <canvas id="canvas"></canvas>

  <div id="loading">
    <div class="spinner"></div>
    <div>Loading...</div>
  </div>

  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.171.0/build/three.module.js",
      "three/tsl": "https://cdn.jsdelivr.net/npm/three@0.171.0/build/three.webgpu.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.171.0/examples/jsm/"
    }
  }
  </script>

  <script type="module">
    import * as THREE from 'three';
    import WebGPURenderer from 'three/webgpu';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { AssetLibrary } from '../assets/AssetLibrary.js';

    // ===== CONFIGURATION =====
    // Update these paths to match your asset pack location
    const PACK_BASE = 'http://localhost:8787/webgpu-threejs-tsl/packs/core/';
    const CATALOG_URL = 'http://localhost:8787/webgpu-threejs-tsl/packs/core/catalogs/core.catalog.json';

    // Asset IDs to load (customize these)
    const MATERIAL_ID = 'pbr/oak-wood';           // PBR material to use
    const ENVIRONMENT_ID = 'env/studio-neutral';  // HDR environment
    const MODEL_ID = 'model/suzanne';             // 3D model

    // ===== SCENE SETUP =====
    let scene, camera, renderer, controls;

    async function init() {
      const canvas = document.getElementById('canvas');
      const loading = document.getElementById('loading');

      try {
        // Create scene
        scene = new THREE.Scene();

        // Create camera
        camera = new THREE.PerspectiveCamera(
          75,
          window.innerWidth / window.innerHeight,
          0.1,
          1000
        );
        camera.position.set(0, 0, 5);

        // Create WebGPU renderer
        renderer = new WebGPURenderer({ canvas, antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1.0;

        await renderer.init();

        // Setup camera controls
        controls = new OrbitControls(camera, canvas);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;

        // ===== ASSET LIBRARY SETUP =====

        // Initialize AssetLibrary singleton
        const assets = AssetLibrary.getInstance({
          packs: {
            core: PACK_BASE
            // Add more packs here:
            // custom: 'https://cdn.example.com/packs/custom/'
          },
          enableCache: true,      // Enable browser caching
          cacheVersion: '1.0.0'   // Change to invalidate cache
        });

        // Initialize with renderer (required for PMREM generation)
        assets.initialize(renderer);

        // Register catalog
        await assets.registerCatalogFromUrl(CATALOG_URL, {
          packId: 'core',
          baseUri: PACK_BASE
        });

        console.log('✅ Asset library initialized');

        // ===== LOAD ASSETS =====

        // Load all assets in parallel for faster loading
        const [material, envMap, model] = await Promise.all([
          // Load PBR material
          assets.createPBRMaterial(MATERIAL_ID),

          // Load HDR environment with PMREM
          assets.getEnvironment(ENVIRONMENT_ID, { pmrem: true }),

          // Load 3D model
          assets.getModel(MODEL_ID)
        ]);

        console.log('✅ Assets loaded');

        // ===== SETUP SCENE =====

        // Apply environment
        scene.environment = envMap;
        scene.background = envMap;

        // Apply material to model
        model.traverse(child => {
          if (child.isMesh) {
            child.material = material;
            child.castShadow = true;
            child.receiveShadow = true;
          }
        });

        scene.add(model);

        // ===== OPTIONAL: ADD LIGHTS =====
        // (Not required when using HDR environment, but can supplement)

        // const light = new THREE.DirectionalLight(0xffffff, 1);
        // light.position.set(5, 5, 5);
        // light.castShadow = true;
        // scene.add(light);

        // ===== START ANIMATION =====
        animate();

        loading.classList.add('hidden');

      } catch (error) {
        console.error('❌ Initialization failed:', error);
        loading.innerHTML = `
          <div style="color: #ff4444;">Error: ${error.message}</div>
          <div style="font-size: 14px; margin-top: 10px; color: #999;">
            Check console for details
          </div>
        `;
      }
    }

    // ===== ANIMATION LOOP =====
    function animate() {
      requestAnimationFrame(animate);

      controls.update();
      renderer.renderAsync(scene, camera);
    }

    // ===== HANDLE WINDOW RESIZE =====
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    // ===== START APPLICATION =====
    init();

    // ===== CUSTOMIZATION EXAMPLES =====

    /*

    // Load different material:
    const metalMaterial = await assets.createPBRMaterial('pbr/brushed-aluminum', {
      roughness: 0.3,  // Override default roughness
      metalness: 1.0   // Override default metalness
    });

    // Load just textures (for custom material):
    const textures = await assets.loadPBRTextures('pbr/oak-wood');
    const customMaterial = new THREE.MeshStandardNodeMaterial();
    customMaterial.map = textures.albedo;
    customMaterial.normalMap = textures.normal;
    customMaterial.aoMap = textures.orm;
    customMaterial.roughnessMap = textures.orm;
    customMaterial.metalnessMap = textures.orm;

    // Switch environment at runtime:
    const sunsetEnv = await assets.getEnvironment('env/outdoor-sunset', {
      pmrem: true,
      intensity: 1.2,
      exposure: 0.5
    });
    scene.environment = sunsetEnv;
    scene.background = sunsetEnv;

    // Query available assets:
    const allMaterials = assets.query({ type: 'pbr-texture-set' });
    const metalMaterials = assets.query({ type: 'pbr-texture-set', tags: ['metal'] });
    const outdoorEnvs = assets.query({ type: 'environment', tags: ['outdoor'] });

    // Get cache statistics:
    const stats = assets.getCacheStats();
    console.log('Cache stats:', stats);

    // Clear cache:
    await assets.clearCache();

    */
  </script>
</body>
</html>
